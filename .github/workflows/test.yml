name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # Define service environment variables for all steps
    env:
      # Use H2 for fast, in-memory testing
      SPRING_PROFILES_ACTIVE: e2e
      SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. BUILD DOCKER IMAGES ---
      - name: Build Docker Images (Backend & Frontend)
        # Use docker-compose to build the multi-stage images
        run: docker-compose build

      # --- 2. START SERVICES FOR E2E ---
      - name: Start Services (Backend and Frontend)
        # Use -d for detached mode, and --wait for healthchecks
        run: docker-compose up -d --wait

      # --- 3. BACKEND UNIT & REPORTING (Runs inside the container) ---
      # We use 'docker exec' to run Maven commands inside the built backend container
      - name: Run Backend Unit Tests and Generate XML Reports
        # The 'test' phase runs the tests, creating XML files in target/surefire-reports
        run: docker exec -w /app backend mvn clean test

      - name: Generate Backend HTML Reports (Surefire & Failsafe)
        # Run the 'report-only' goal to convert the XML reports into HTML
        run: |
          docker exec -w /app backend mvn surefire-report:report-only
          docker exec -w /app backend mvn failsafe-report:report-only

      # --- 4. FRONTEND E2E TESTS (Runs on host, targeting Docker services) ---
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Run Frontend E2E Tests (Playwright)
        # Playwright calls the backend on localhost:8080 (exposed port)
        # Playwright reports go to frontend/playwright-report
        run: npx playwright test
        working-directory: ./frontend

      # --- 5. COLLECT AND ARTIFACT REPORTS ---
      - name: Create Unified Report Directory
        run: |
          mkdir -p gh-pages-reports/test-results/backend
          mkdir -p gh-pages-reports/test-results/frontend

      - name: Copy Backend HTML Reports
        # Copy reports from the *running container* to the host filesystem
        run: |
          # Copy Surefire reports (Unit Tests)
          docker cp $(docker-compose ps -q backend):/app/target/test-reports/surefire-html/. gh-pages-reports/test-results/backend
          # Copy Failsafe reports (Integration Tests)
          docker cp $(docker-compose ps -q backend):/app/target/test-reports/failsafe-html/. gh-pages-reports/test-results/backend

      - name: Copy Frontend HTML Reports (Playwright)
        # Playwright reports are already on the host filesystem (frontend/playwright-report)
        run: |
          cp -r frontend/playwright-report/. gh-pages-reports/test-results/frontend/

      - name: Create Index Page for GitHub Pages
        run: cp test-results-index.html gh-pages-reports/index.html
      
      - name: Upload Report Artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          # This is the directory that will be served by GitHub Pages
          path: 'gh-pages-reports'

  # --- 6. DEPLOY REPORTS TO GITHUB PAGES ---
  deploy-reports:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-and-test
    # Grant GITHUB_TOKEN the needed permissions for deployment
    permissions:
      pages: write
      id-token: write
      contents: read
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4