# ------------------
# 1. Environment Setup
# ------------------
env:
  # The base URL of your running application
  target: "http://localhost:8080"

  # API Docs URL - typically /v3/api-docs for SpringDoc/OpenAPI 3
  api_spec_url: "http://localhost:8080/v3/api-docs"

  # Timeout for the full scan
  max_scan_duration: 30 # minutes

# ------------------
# 2. Global Context: Authentication Setup
# ------------------
contexts:
  - name: AuthContext
    urls:
      # Scope the scan to everything under the base URL
      - ${env.target}

    # Define the authentication method
    authentication:
      method: "json"
      parameters:
        # The login URL for Bearer token acquisition
        loginUrl: "http://localhost:8080/api/auth/login"
        # The POST data payload (using environment variables from your GitHub workflow)
        loginRequestBody: '{"username":"${TEST_USERNAME}","password":"${TEST_PASSWORD}"}'
        loginRequestHeaders: "Content-Type: application/json"

      # Define how to check if the user is authenticated (e.g., check HTTP response code)
      loggedinindicator: "HTTP 200"

    # Define the session management (how to maintain the session/token)
    sessionManagement:
      method: "bearer"
      parameters:
        # Key in the login JSON response containing the JWT token (e.g., 'token', 'access_token')
        # YOU MUST ADJUST THIS KEY based on your backend's JSON response!
        tokenExtractionKey: "token"

# ------------------
# 3. ZAP Jobs Definition
# ------------------
jobs:
  # Job 1: Load the OpenAPI Specification
  - name: openapi-import
    type: openapi
    parameters:
      # Import the specification using the URL defined in the environment
      url: ${env.api_spec_url}
      # The target URL that the imported URLs map to
      target: ${env.target}

    # Use the context defined above for authentication
    context: AuthContext

  # Job 2: Run Passive Scan (Fast, no risk)
  - name: passiveScan
    type: passiveScan
    parameters:
      # Run for a maximum of 5 minutes (or until all history is processed)
      maxDuration: 5

  # Job 3: Run Active Scan (Slower, higher risk, performs attacks)
  - name: activeScan
    type: activeScan
    parameters:
      # Set the maximum time for the active scan
      maxDuration: ${env.max_scan_duration}
      # Set the scanning policy (e.g., default, minimal, etc.)
      policy: "Default"
      # Maximum number of requests per second (to avoid overloading the application)
      maxAps: 10

    # Apply the authenticated context for the active scan
    context: AuthContext

  # Job 4: Generate Reports (verbose templates)
  - name: report-html
    type: report
    parameters:
      template: traditional-html-plus
      reportDir: zap-reports
      reportFileName: zap-report-full.html

  - name: report-json
    type: report
    parameters:
      template: traditional-json-plus
      reportDir: zap-reports
      reportFileName: zap-report.json

  - name: report-xml
    type: report
    parameters:
      template: traditional-xml-plus
      reportDir: zap-reports
      reportFileName: zap-report.xml

  - name: report-md
    type: report
    parameters:
      template: traditional-md
      reportDir: zap-reports
      reportFileName: zap-report.md
